<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculateur ROI - Équipement Industriel</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/><circle cx="50" cy="10" r="0.5" fill="white" opacity="0.05"/></pattern></defs><rect width="100%" height="100%" fill="url(%23grain)"/></svg>');
            pointer-events: none;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            box-shadow: 0 32px 64px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #667eea 100%);
            color: white;
            padding: 40px 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: rotate 20s linear infinite;
        }

        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .header-content {
            position: relative;
            z-index: 2;
        }

        .header h1 {
            font-size: 3rem;
            margin-bottom: 15px;
            font-weight: 800;
            background: linear-gradient(45deg, #fff, #e3f2fd);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.95;
            font-weight: 400;
        }

        .header-stats {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .header-stat {
            text-align: center;
        }

        .header-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #ffd700;
        }

        .header-stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-top: 4px;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1.2fr 1.8fr;
            gap: 40px;
            padding: 40px;
        }

        .input-section {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(0, 0, 0, 0.05);
            position: relative;
            overflow: hidden;
        }

        .input-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2, #f093fb);
        }

        .input-group {
            margin-bottom: 30px;
            position: relative;
        }

        .input-group h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.4rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            border-left: 4px solid #667eea;
        }

        .input-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 15px 20px;
            border-radius: 12px;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }

        .input-row:hover {
            background: linear-gradient(135deg, #f8f9fa 0%, #e3f2fd 100%);
            border-color: #667eea;
            transform: translateX(5px);
        }

        .input-row label {
            font-weight: 500;
            color: #555;
            flex: 1;
            font-size: 0.95rem;
        }

        .input-row input {
            width: 140px;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s ease;
            background: white;
        }

        .input-row input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
            transform: scale(1.02);
        }

        .calculate-btn {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 18px;
            border-radius: 15px;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
            position: relative;
            overflow: hidden;
        }

        .calculate-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .calculate-btn:hover::before {
            left: 100%;
        }

        .calculate-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 20px 40px rgba(102, 126, 234, 0.4);
        }

        .results-section {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(0, 0, 0, 0.05);
            position: relative;
            overflow: hidden;
        }

        .results-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #27ae60, #2ecc71, #58d68d);
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .results-header h3 {
            color: #2c3e50;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .action-buttons {
            display: flex;
            gap: 12px;
        }

        .copy-btn, .export-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 12px 18px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .copy-btn:hover, .export-btn:hover {
            background: #219a52;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(39, 174, 96, 0.3);
        }

        .export-btn {
            background: #3498db;
        }

        .export-btn:hover {
            background: #2980b9;
        }

        .recommendation {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            font-weight: 600;
            text-align: center;
            box-shadow: 0 10px 30px rgba(39, 174, 96, 0.2);
        }

        .recommendation.warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }

        .recommendation.danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            border: 1px solid rgba(0, 0, 0, 0.05);
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease;
        }

        .kpi-card:hover {
            transform: translateY(-5px);
        }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .kpi-card h4 {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .kpi-value {
            font-size: 2.2rem;
            font-weight: 800;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .kpi-value.positive {
            color: #27ae60;
        }

        .kpi-value.negative {
            color: #e74c3c;
        }

        .kpi-trend {
            font-size: 0.8rem;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .chart-container {
            margin: 25px 0;
            height: 350px;
            background: #fafafa;
            border-radius: 12px;
            padding: 15px;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 30px;
        }

        .chart-card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(0, 0, 0, 0.05);
            position: relative;
            overflow: hidden;
        }

        .chart-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #f093fb, #f5576c, #4facfe);
        }

        .chart-card h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.3rem;
            font-weight: 700;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 14px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        }

        .results-table th,
        .results-table td {
            padding: 15px 12px;
            text-align: right;
            border-bottom: 1px solid #f1f3f4;
        }

        .results-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.85rem;
        }

        .results-table td:first-child,
        .results-table th:first-child {
            text-align: left;
        }

        .results-table tbody tr:hover {
            background: #f8f9fa;
        }

        .profit {
            color: #27ae60;
            font-weight: 700;
        }

        .loss {
            color: #e74c3c;
            font-weight: 700;
        }

        .icon {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }

        .impact-indicators {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .impact-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(0, 0, 0, 0.05);
            position: relative;
            overflow: hidden;
        }

        .impact-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
        }

        .impact-card.environmental::before {
            background: linear-gradient(90deg, #2ecc71, #27ae60);
        }

        .impact-card.financial::before {
            background: linear-gradient(90deg, #f39c12, #e67e22);
        }

        .impact-card.productivity::before {
            background: linear-gradient(90deg, #3498db, #2980b9);
        }

        .impact-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 15px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .impact-icon.environmental {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
        }

        .impact-icon.financial {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }

        .impact-card.efficiency::before {
            background: linear-gradient(90deg, #9b59b6, #8e44ad);
        }

        .impact-icon.efficiency {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
        }

        .impact-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .impact-value {
            font-size: 1.8rem;
            font-weight: 800;
            margin-bottom: 8px;
        }

        .impact-description {
            font-size: 0.9rem;
            color: #666;
        }

        .copy-area {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-top: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .savings-highlight {
            background: linear-gradient(135deg, #ff6b6b, #feca57);
            background-size: 200% 200%;
            animation: gradientShift 3s ease infinite;
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin: 20px 0;
            font-weight: 700;
            font-size: 1.2rem;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .kpi-grid {
                grid-template-columns: 1fr 1fr;
            }

            .header h1 {
                font-size: 2rem;
            }

            .impact-indicators {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 600px) {
            .input-row {
                flex-direction: column;
                align-items: flex-start;
            }

            .input-row input {
                width: 100%;
                margin-top: 8px;
            }

            .main-content {
                padding: 20px;
            }
        }

        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">
        <div>Génération de l'image en cours...</div>
    </div>

    <div class="container">
        <div class="header">
            <div class="header-content">
                <h1>Calculateur ROI Pro</h1>
                <p>Analyse comparative des solutions d'équipement industriel</p>
                <div class="header-stats">
                    <div class="header-stat">
                        <div class="header-stat-value" id="total-savings">0 €</div>
                        <div class="header-stat-label">Économies potentielles</div>
                    </div>
                    <div class="header-stat">
                        <div class="header-stat-value" id="best-solution">-</div>
                        <div class="header-stat-label">Meilleure solution</div>
                    </div>
                    <div class="header-stat">
                        <div class="header-stat-value" id="payback-period">-</div>
                        <div class="header-stat-label">Retour sur investissement</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="input-section">
                <div class="input-group">
                    <h3>
                        <svg class="icon" viewBox="0 0 24 24"><path d="M12 2L2 7v10c0 5.55 3.84 9.6 9 11 5.16-1.4 9-5.45 9-11V7l-10-5z"/></svg>
                        Équipement Existant
                    </h3>
                    <div class="input-row">
                        <label>Maintenance compresseur (€)</label>
                        <input type="number" id="maintenance-existant" value="7340">
                    </div>
                    <div class="input-row">
                        <label>Maintenance sécheur (€)</label>
                        <input type="number" id="maintenance-secheur-existant" value="0">
                    </div>
                    <div class="input-row">
                        <label>Coût énergétique (€)</label>
                        <input type="number" id="cout-energetique-existant" value="3000">
                    </div>
                </div>

                <div class="input-group">
                    <h3>
                        <svg class="icon" viewBox="0 0 24 24"><path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9z"/></svg>
                        Solution 1 - Premium
                    </h3>
                    <div class="input-row">
                        <label>Investissement initial (€)</label>
                        <input type="number" id="investissement-1" value="29136">
                    </div>
                    <div class="input-row">
                        <label>Maintenance annuelle (€)</label>
                        <input type="number" id="maintenance-1" value="10073">
                    </div>
                    <div class="input-row">
                        <label>Coût énergétique (€)</label>
                        <input type="number" id="cout-energetique-1" value="1000">
                    </div>
                    <div class="input-row">
                        <label>Prime CEE (€)</label>
                        <input type="number" id="prime-cee-1" value="4185">
                    </div>
                </div>

                <div class="input-group">
                    <h3>
                        <svg class="icon" viewBox="0 0 24 24"><path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9z"/></svg>
                        Solution 2 - Économique
                    </h3>
                    <div class="input-row">
                        <label>Investissement initial (€)</label>
                        <input type="number" id="investissement-2" value="22721">
                    </div>
                    <div class="input-row">
                        <label>Maintenance annuelle (€)</label>
                        <input type="number" id="maintenance-2" value="7631">
                    </div>
                    <div class="input-row">
                        <label>Coût énergétique (€)</label>
                        <input type="number" id="cout-energetique-2" value="1000">
                    </div>
                    <div class="input-row">
                        <label>Prime CEE (€)</label>
                        <input type="number" id="prime-cee-2" value="3069">
                    </div>
                </div>

                <button class="calculate-btn" onclick="calculerROI()">
                    <svg class="icon" viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
                    Calculer le ROI
                </button>
            </div>

            <div class="results-section">
                <div class="results-header">
                    <h3>🎯 Analyse des Résultats</h3>
                    <div class="action-buttons">
                        <button class="copy-btn" onclick="copierResultats()">
                            <svg class="icon" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
                            Copier Texte
                        </button>
                        <button class="export-btn" onclick="exporterImage()">
                            <svg class="icon" viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
                            Copier Image
                        </button>
                    </div>
                </div>

                <div class="recommendation" id="recommendation">
                    💡 Calculez votre ROI pour obtenir une recommandation personnalisée
                </div>

                <div class="kpi-grid">
                    <div class="kpi-card">
                        <h4>💰 ROI Solution 1</h4>
                        <div class="kpi-value" id="roi-solution-1">-</div>
                        <div class="kpi-trend" id="trend-solution-1">sur 5 ans</div>
                    </div>
                    <div class="kpi-card">
                        <h4>💰 ROI Solution 2</h4>
                        <div class="kpi-value" id="roi-solution-2">-</div>
                        <div class="kpi-trend" id="trend-solution-2">sur 5 ans</div>
                    </div>
                    <div class="kpi-card">
                        <h4>⏱️ Retour Sol. 1</h4>
                        <div class="kpi-value" id="payback-solution-1">-</div>
                        <div class="kpi-trend">temps d'amortissement</div>
                    </div>
                    <div class="kpi-card">
                        <h4>⏱️ Retour Sol. 2</h4>
                        <div class="kpi-value" id="payback-solution-2">-</div>
                        <div class="kpi-trend">temps d'amortissement</div>
                    </div>
                </div>

                <div class="impact-indicators">
                    <div class="impact-card environmental">
                        <div class="impact-icon environmental">
                            <svg class="icon" viewBox="0 0 24 24"><path d="M17 8C8 10 5.9 16.17 3.82 21.34l1.89.66.95-2.66c.03-.08.06-.17.09-.25.16-.42.25-.88.25-1.34C7 17.22 7.78 16.44 8.31 16.44s1.31.78 1.31 1.31c0 .46.09.92.25 1.34.03.08.06.17.09.25l.95 2.66 1.89-.66C10.1 16.17 8 10 17 8z"/></svg>
                        </div>
                        <div class="impact-title">Impact Environnemental</div>
                        <div class="impact-value" id="co2-savings">0%</div>
                        <div class="impact-description">Réduction consommation énergétique</div>
                    </div>
                    <div class="impact-card financial">
                        <div class="impact-icon financial">
                            <svg class="icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1.41 16.09V20h-2.67v-1.93c-1.71-.36-3.16-1.46-3.27-3.4h1.96c.1 1.05.82 1.87 2.65 1.87 1.96 0 2.4-.98 2.4-1.59 0-.83-.44-1.61-2.67-2.14-2.48-.6-4.18-1.62-4.18-3.67 0-1.72 1.39-2.84 3.11-3.21V4h2.67v1.95c1.86.45 2.79 1.86 2.85 3.39H14.3c-.05-1.11-.64-1.87-2.22-1.87-1.5 0-2.4.68-2.4 1.64 0 .84.65 1.39 2.67 1.91s4.18 1.39 4.18 3.91c-.01 1.83-1.38 2.83-3.12 3.16z"/></svg>
                        </div>
                        <div class="impact-title">Gain Financier</div>
                        <div class="impact-value" id="total-savings-5y">0 €</div>
                        <div class="impact-description">Économies sur 5 ans</div>
                    </div>
                    <div class="impact-card productivity">
                        <div class="impact-icon productivity">
                            <svg class="icon" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                        </div>
                        <div class="impact-title">Amélioration Productivité</div>
                        <div class="impact-value" id="productivity-gain">0%</div>
                        <div class="impact-description">Réduction coûts maintenance</div>
                    </div>
                </div>

                <div class="chart-container">
                    <canvas id="cumulativeChart"></canvas>
                </div>

                <table class="results-table" id="results-table">
                    <thead>
                        <tr>
                            <th>📅 Période</th>
                            <th>🔧 Équipement Existant</th>
                            <th>🚀 Solution 1</th>
                            <th>💡 Solution 2</th>
                            <th>💰 Économies Sol. 1</th>
                            <th>💰 Économies Sol. 2</th>
                        </tr>
                    </thead>
                    <tbody id="results-body">
                        <!-- Les résultats seront ajoutés ici par JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <div class="charts-grid full-width">
            <div class="chart-card">
                <h3>📊 Évolution des coûts annuels</h3>
                <div class="chart-container">
                    <canvas id="annualChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h3>💎 Économies par solution</h3>
                <div class="chart-container">
                    <canvas id="savingsChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="copy-area" id="copy-area" style="display: none;">
            <div class="header">
                <div class="header-content">
                    <h1>Analyse ROI - Équipement Industriel</h1>
                    <p>Rapport détaillé des solutions d'investissement</p>
                </div>
            </div>
            
            <div style="padding: 30px; background: white;">
                <div class="recommendation" id="copy-recommendation">
                    <!-- Recommandation pour la copie -->
                </div>
                
                <div class="kpi-grid" id="copy-kpis">
                    <!-- KPIs pour la copie -->
                </div>
                
                <div class="impact-indicators" id="copy-impacts">
                    <!-- Impacts pour la copie -->
                </div>
                
                <div style="margin-top: 30px;">
                    <canvas id="copyChart" width="800" height="400"></canvas>
                </div>
                
                <table class="results-table" id="copy-table">
                    <!-- Tableau pour la copie -->
                </table>
                
                <div style="margin-top: 30px; text-align: center; color: #666; font-size: 14px;">
                    <p id="report-date">📅 Rapport généré le</p>
                    <p>🏢 Calculateur ROI Pro - Analyse comparative d'équipements industriels</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let cumulativeChart, annualChart, savingsChart, copyChart;
        let resultatsGlobaux = {};

        function calculerROI() {
            // Récupération des valeurs
            const equipementExistant = {
                maintenance: parseFloat(document.getElementById('maintenance-existant').value) || 0,
                maintenanceSecheur: parseFloat(document.getElementById('maintenance-secheur-existant').value) || 0,
                coutEnergetique: parseFloat(document.getElementById('cout-energetique-existant').value) || 0
            };

            const solution1 = {
                investissement: parseFloat(document.getElementById('investissement-1').value) || 0,
                maintenance: parseFloat(document.getElementById('maintenance-1').value) || 0,
                coutEnergetique: parseFloat(document.getElementById('cout-energetique-1').value) || 0,
                primeCEE: parseFloat(document.getElementById('prime-cee-1').value) || 0
            };

            const solution2 = {
                investissement: parseFloat(document.getElementById('investissement-2').value) || 0,
                maintenance: parseFloat(document.getElementById('maintenance-2').value) || 0,
                coutEnergetique: parseFloat(document.getElementById('cout-energetique-2').value) || 0,
                primeCEE: parseFloat(document.getElementById('prime-cee-2').value) || 0
            };

            // Calculs sur 5 ans
            const annees = [1, 2, 3, 4, 5];
            const resultats = {
                equipementExistant: { annuel: [], cumule: [] },
                solution1: { annuel: [], cumule: [], economiesAnnuelles: [], investissementNet: 0 },
                solution2: { annuel: [], cumule: [], economiesAnnuelles: [], investissementNet: 0 }
            };

            // Investissements nets (après primes)
            resultats.solution1.investissementNet = solution1.investissement - solution1.primeCEE;
            resultats.solution2.investissementNet = solution2.investissement - solution2.primeCEE;

            // Calculs pour équipement existant
            let cumuleExistant = 0;
            const coutAnnuelExistant = equipementExistant.maintenance + equipementExistant.maintenanceSecheur + equipementExistant.coutEnergetique;
            
            // Pour la première année de l'équipement existant, on a un coût initial de maintenance plus élevé
            const coutAnnuel1Existant = 29483; // Première année avec coût de maintenance initial
            
            annees.forEach((annee, index) => {
                let coutAnnuel;
                if (index === 0) {
                    coutAnnuel = coutAnnuel1Existant + equipementExistant.coutEnergetique;
                } else {
                    coutAnnuel = coutAnnuelExistant;
                }
                
                cumuleExistant += coutAnnuel;
                resultats.equipementExistant.annuel.push(coutAnnuel);
                resultats.equipementExistant.cumule.push(cumuleExistant);
            });

            // Calculs pour Solution 1
            let cumuleSolution1 = resultats.solution1.investissementNet;
            const coutAnnuelSolution1 = solution1.maintenance + solution1.coutEnergetique;
            
            annees.forEach((annee, index) => {
                let coutAnnuel = coutAnnuelSolution1;
                cumuleSolution1 += coutAnnuel;
                
                resultats.solution1.annuel.push(coutAnnuel);
                resultats.solution1.cumule.push(cumuleSolution1);
                
                const economie = resultats.equipementExistant.cumule[index] - cumuleSolution1;
                resultats.solution1.economiesAnnuelles.push(economie);
            });

            // Calculs pour Solution 2
            let cumuleSolution2 = resultats.solution2.investissementNet;
            const coutAnnuelSolution2 = solution2.maintenance + solution2.coutEnergetique;
            
            annees.forEach((annee, index) => {
                let coutAnnuel = coutAnnuelSolution2;
                cumuleSolution2 += coutAnnuel;
                
                resultats.solution2.annuel.push(coutAnnuel);
                resultats.solution2.cumule.push(cumuleSolution2);
                
                const economie = resultats.equipementExistant.cumule[index] - cumuleSolution2;
                resultats.solution2.economiesAnnuelles.push(economie);
            });

            // Calcul du ROI et temps de retour
            const roiSolution1 = ((resultats.solution1.economiesAnnuelles[4]) / resultats.solution1.investissementNet * 100);
            const roiSolution2 = ((resultats.solution2.economiesAnnuelles[4]) / resultats.solution2.investissementNet * 100);

            // Temps de retour (en années)
            let paybackSolution1 = null;
            let paybackSolution2 = null;

            for (let i = 0; i < 5; i++) {
                if (paybackSolution1 === null && resultats.solution1.economiesAnnuelles[i] > 0) {
                    paybackSolution1 = i + 1;
                }
                if (paybackSolution2 === null && resultats.solution2.economiesAnnuelles[i] > 0) {
                    paybackSolution2 = i + 1;
                }
            }

            resultatsGlobaux = resultats;

            // Mise à jour de l'affichage
            afficherResultats(resultats, roiSolution1, roiSolution2, paybackSolution1, paybackSolution2);
            mettreAJourHeader(resultats, roiSolution1, roiSolution2, paybackSolution1, paybackSolution2);
            creerGraphiques(resultats);
        }

        function mettreAJourHeader(resultats, roiSolution1, roiSolution2, paybackSolution1, paybackSolution2) {
            // Déterminer la meilleure solution
            const economiesSol1 = resultats.solution1.economiesAnnuelles[4];
            const economiesSol2 = resultats.solution2.economiesAnnuelles[4];
            
            let meilleureSolution, meilleuresEconomies, meilleurPayback;
            if (economiesSol1 > economiesSol2) {
                meilleureSolution = "Solution 1";
                meilleuresEconomies = economiesSol1;
                meilleurPayback = paybackSolution1;
            } else {
                meilleureSolution = "Solution 2";
                meilleuresEconomies = economiesSol2;
                meilleurPayback = paybackSolution2;
            }
            
            // Mise à jour avec vérifications de sécurité
            const totalSavingsElement = document.getElementById('total-savings');
            if (totalSavingsElement) {
                totalSavingsElement.textContent = formatEuro(Math.max(economiesSol1, economiesSol2));
            }
            
            const bestSolutionElement = document.getElementById('best-solution');
            if (bestSolutionElement) {
                bestSolutionElement.textContent = meilleureSolution;
            }
            
            const paybackPeriodElement = document.getElementById('payback-period');
            if (paybackPeriodElement) {
                paybackPeriodElement.textContent = meilleurPayback ? meilleurPayback + ' ans' : '> 5 ans';
            }
        }

        function afficherResultats(resultats, roiSolution1, roiSolution2, paybackSolution1, paybackSolution2) {
            // Mise à jour des KPIs
            document.getElementById('roi-solution-1').textContent = roiSolution1.toFixed(1) + '%';
            document.getElementById('roi-solution-1').className = `kpi-value ${roiSolution1 > 0 ? 'positive' : 'negative'}`;
            
            document.getElementById('roi-solution-2').textContent = roiSolution2.toFixed(1) + '%';
            document.getElementById('roi-solution-2').className = `kpi-value ${roiSolution2 > 0 ? 'positive' : 'negative'}`;
            
            document.getElementById('payback-solution-1').textContent = paybackSolution1 ? paybackSolution1 + ' ans' : '> 5 ans';
            document.getElementById('payback-solution-2').textContent = paybackSolution2 ? paybackSolution2 + ' ans' : '> 5 ans';

            // Calcul des économies pour les impacts
            const economiesSol1 = resultats.solution1.economiesAnnuelles[4];
            const economiesSol2 = resultats.solution2.economiesAnnuelles[4];
            
            // Mise à jour des impacts calculés dynamiquement
            const meilleuresEconomies = Math.max(economiesSol1, economiesSol2);
            
            // Récupération des valeurs actuelles des inputs pour les calculs
            const equipementExistant = {
                maintenance: parseFloat(document.getElementById('maintenance-existant').value) || 0,
                maintenanceSecheur: parseFloat(document.getElementById('maintenance-secheur-existant').value) || 0,
                coutEnergetique: parseFloat(document.getElementById('cout-energetique-existant').value) || 0
            };
            
            // Calcul de l'impact environnemental (réduction consommation énergétique)
            const coutEnergetiqueExistant = equipementExistant.coutEnergetique;
            const coutEnergetiqueMeilleureSolution = economiesSol1 > economiesSol2 ? 
                parseFloat(document.getElementById('cout-energetique-1').value) : 
                parseFloat(document.getElementById('cout-energetique-2').value);
            
            const reductionEnergetique = coutEnergetiqueExistant > 0 ? 
                ((coutEnergetiqueExistant - coutEnergetiqueMeilleureSolution) / coutEnergetiqueExistant * 100) : 0;
            
            // Calcul de l'amélioration de productivité (réduction maintenance)
            const maintenanceExistante = equipementExistant.maintenance + equipementExistant.maintenanceSecheur;
            const maintenanceMeilleureSolution = economiesSol1 > economiesSol2 ? 
                parseFloat(document.getElementById('maintenance-1').value) : 
                parseFloat(document.getElementById('maintenance-2').value);
            
            const ameliorationProductivite = maintenanceExistante > 0 ? 
                ((maintenanceExistante - maintenanceMeilleureSolution) / maintenanceExistante * 100) : 0;
            
            // Mise à jour de l'affichage des impacts (avec vérifications de sécurité)
            const co2Element = document.getElementById('co2-savings');
            if (co2Element) {
                co2Element.textContent = reductionEnergetique > 0 ? 
                    `-${reductionEnergetique.toFixed(0)}%` : '0%';
                co2Element.className = `impact-value ${reductionEnergetique > 0 ? 'positive' : ''}`;
            }
            
            const productivityElement = document.getElementById('productivity-gain');
            if (productivityElement) {
                productivityElement.textContent = ameliorationProductivite > 0 ? 
                    `+${ameliorationProductivite.toFixed(0)}%` : ameliorationProductivite < 0 ? 
                    `${ameliorationProductivite.toFixed(0)}%` : '0%';
                productivityElement.className = `impact-value ${ameliorationProductivite > 0 ? 'positive' : ameliorationProductivite < 0 ? 'negative' : ''}`;
            }
            
            const savingsElement = document.getElementById('total-savings-5y');
            if (savingsElement) {
                savingsElement.textContent = formatEuro(meilleuresEconomies);
            }

            // Recommandation
            let recommandation = '';
            let classeRecommandation = '';
            
            if (economiesSol1 > 0 && economiesSol2 > 0) {
                if (economiesSol1 > economiesSol2) {
                    recommandation = `🎯 RECOMMANDATION: La Solution 1 est optimale avec ${formatEuro(economiesSol1)} d'économies sur 5 ans !`;
                    classeRecommandation = '';
                } else {
                    recommandation = `🎯 RECOMMANDATION: La Solution 2 est optimale avec ${formatEuro(economiesSol2)} d'économies sur 5 ans !`;
                    classeRecommandation = '';
                }
            } else if (economiesSol1 > 0 || economiesSol2 > 0) {
                recommandation = `⚠️ ATTENTION: Une seule solution est profitable. Analysez attentivement vos besoins.`;
                classeRecommandation = 'warning';
            } else {
                recommandation = `🚨 ALERTE: Aucune solution n'est profitable sur 5 ans. Réévaluez les paramètres.`;
                classeRecommandation = 'danger';
            }
            
            const recommendationElement = document.getElementById('recommendation');
            if (recommendationElement) {
                recommendationElement.textContent = recommandation;
                recommendationElement.className = `recommendation ${classeRecommandation}`;
            }

            // Mise à jour du tableau
            const tbody = document.getElementById('results-body');
            tbody.innerHTML = '';

            for (let i = 0; i < 5; i++) {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><strong>Année ${i + 1}</strong></td>
                    <td>${formatEuro(resultats.equipementExistant.cumule[i])}</td>
                    <td>${formatEuro(resultats.solution1.cumule[i])}</td>
                    <td>${formatEuro(resultats.solution2.cumule[i])}</td>
                    <td class="${resultats.solution1.economiesAnnuelles[i] >= 0 ? 'profit' : 'loss'}">
                        ${resultats.solution1.economiesAnnuelles[i] >= 0 ? '💰' : '⚠️'} ${formatEuro(resultats.solution1.economiesAnnuelles[i])}
                    </td>
                    <td class="${resultats.solution2.economiesAnnuelles[i] >= 0 ? 'profit' : 'loss'}">
                        ${resultats.solution2.economiesAnnuelles[i] >= 0 ? '💰' : '⚠️'} ${formatEuro(resultats.solution2.economiesAnnuelles[i])}
                    </td>
                `;
            }
        }

        function formatEuro(montant) {
            return new Intl.NumberFormat('fr-FR', {
                style: 'currency',
                currency: 'EUR',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(montant);
        }

        function creerGraphiques(resultats) {
            const annees = ['Année 1', 'Année 2', 'Année 3', 'Année 4', 'Année 5'];

            // Configuration commune pour tous les graphiques
            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            font: {
                                size: 12,
                                weight: '600'
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0,0,0,0.1)'
                        },
                        ticks: {
                            callback: function(value) {
                                return formatEuro(value);
                            },
                            font: {
                                size: 11
                            }
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            font: {
                                size: 11
                            }
                        }
                    }
                }
            };

            // Graphique des coûts cumulés
            if (cumulativeChart) cumulativeChart.destroy();
            const ctxCumulative = document.getElementById('cumulativeChart').getContext('2d');
            cumulativeChart = new Chart(ctxCumulative, {
                type: 'line',
                data: {
                    labels: annees,
                    datasets: [{
                        label: '🔧 Équipement Existant',
                        data: resultats.equipementExistant.cumule,
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        tension: 0.4,
                        fill: false,
                        borderWidth: 3,
                        pointRadius: 6,
                        pointHoverRadius: 8
                    }, {
                        label: '🚀 Solution 1 Premium',
                        data: resultats.solution1.cumule,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        tension: 0.4,
                        fill: false,
                        borderWidth: 3,
                        pointRadius: 6,
                        pointHoverRadius: 8
                    }, {
                        label: '💡 Solution 2 Économique',
                        data: resultats.solution2.cumule,
                        borderColor: '#27ae60',
                        backgroundColor: 'rgba(39, 174, 96, 0.1)',
                        tension: 0.4,
                        fill: false,
                        borderWidth: 3,
                        pointRadius: 6,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    ...commonOptions,
                    plugins: {
                        ...commonOptions.plugins,
                        title: {
                            display: true,
                            text: '📈 Évolution des coûts cumulés',
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        }
                    }
                }
            });

            // Graphique des coûts annuels
            if (annualChart) annualChart.destroy();
            const ctxAnnual = document.getElementById('annualChart').getContext('2d');
            annualChart = new Chart(ctxAnnual, {
                type: 'bar',
                data: {
                    labels: annees,
                    datasets: [{
                        label: '🔧 Équipement Existant',
                        data: resultats.equipementExistant.annuel,
                        backgroundColor: 'rgba(231, 76, 60, 0.8)',
                        borderRadius: 8
                    }, {
                        label: '🚀 Solution 1',
                        data: resultats.solution1.annuel,
                        backgroundColor: 'rgba(52, 152, 219, 0.8)',
                        borderRadius: 8
                    }, {
                        label: '💡 Solution 2',
                        data: resultats.solution2.annuel,
                        backgroundColor: 'rgba(39, 174, 96, 0.8)',
                        borderRadius: 8
                    }]
                },
                options: commonOptions
            });

            // Graphique des économies
            if (savingsChart) savingsChart.destroy();
            const ctxSavings = document.getElementById('savingsChart').getContext('2d');
            savingsChart = new Chart(ctxSavings, {
                type: 'bar',
                data: {
                    labels: annees,
                    datasets: [{
                        label: '💰 Économies Solution 1',
                        data: resultats.solution1.economiesAnnuelles,
                        backgroundColor: resultats.solution1.economiesAnnuelles.map(val => 
                            val >= 0 ? 'rgba(39, 174, 96, 0.8)' : 'rgba(231, 76, 60, 0.8)'
                        ),
                        borderRadius: 8
                    }, {
                        label: '💰 Économies Solution 2',
                        data: resultats.solution2.economiesAnnuelles,
                        backgroundColor: resultats.solution2.economiesAnnuelles.map(val => 
                            val >= 0 ? 'rgba(52, 152, 219, 0.8)' : 'rgba(231, 76, 60, 0.8)'
                        ),
                        borderRadius: 8
                    }]
                },
                options: commonOptions
            });
        }

        function copierResultats() {
            if (!resultatsGlobaux.equipementExistant) {
                alert('Veuillez d\'abord calculer le ROI');
                return;
            }

            let texte = "🎯 ANALYSE ROI - ÉQUIPEMENT INDUSTRIEL\n";
            texte += "=====================================\n\n";
            
            // KPIs avec vérifications
            const roiSol1Element = document.getElementById('roi-solution-1');
            const roiSol2Element = document.getElementById('roi-solution-2');
            const paybackSol1Element = document.getElementById('payback-solution-1');
            const paybackSol2Element = document.getElementById('payback-solution-2');
            
            const roiSol1 = roiSol1Element ? roiSol1Element.textContent : 'N/A';
            const roiSol2 = roiSol2Element ? roiSol2Element.textContent : 'N/A';
            const paybackSol1 = paybackSol1Element ? paybackSol1Element.textContent : 'N/A';
            const paybackSol2 = paybackSol2Element ? paybackSol2Element.textContent : 'N/A';
            
            texte += "📊 INDICATEURS CLÉS:\n";
            texte += `-----------------\n`;
            texte += `💰 ROI Solution 1: ${roiSol1}\n`;
            texte += `💰 ROI Solution 2: ${roiSol2}\n`;
            texte += `⏱️ Temps de retour Solution 1: ${paybackSol1}\n`;
            texte += `⏱️ Temps de retour Solution 2: ${paybackSol2}\n\n`;
            
            // Recommandation avec vérification
            const recommendationElement = document.getElementById('recommendation');
            if (recommendationElement) {
                texte += `${recommendationElement.textContent}\n\n`;
            }
            
            // Tableau détaillé
            texte += "📈 DÉTAIL PAR ANNÉE:\n";
            texte += "-----------------\n";
            texte += "Année\t\t🔧 Existant\t\t🚀 Solution 1\t\t💡 Solution 2\t\t💰 Éco. Sol.1\t\t💰 Éco. Sol.2\n";
            
            for (let i = 0; i < 5; i++) {
                texte += `${i + 1}\t\t`;
                texte += `${formatEuro(resultatsGlobaux.equipementExistant.cumule[i])}\t\t`;
                texte += `${formatEuro(resultatsGlobaux.solution1.cumule[i])}\t\t`;
                texte += `${formatEuro(resultatsGlobaux.solution2.cumule[i])}\t\t`;
                texte += `${formatEuro(resultatsGlobaux.solution1.economiesAnnuelles[i])}\t\t`;
                texte += `${formatEuro(resultatsGlobaux.solution2.economiesAnnuelles[i])}\n`;
            }
            
            texte += "\n";
            texte += "🎯 IMPACT BUSINESS:\n";
            texte += "-------------------\n";
            
            // Impacts avec vérifications
            const co2Element = document.getElementById('co2-savings');
            const productivityElement = document.getElementById('productivity-gain');
            
            texte += `🌱 Réduction consommation énergétique: ${co2Element ? co2Element.textContent : 'N/A'}\n`;
            texte += `🏭 Amélioration productivité: ${productivityElement ? productivityElement.textContent : 'N/A'}\n`;
            texte += "📅 Rapport généré le " + new Date().toLocaleDateString('fr-FR') + "\n";
            texte += "🏢 Calculateur ROI Pro\n";
            
            // Copier dans le presse-papier
            navigator.clipboard.writeText(texte).then(() => {
                // Feedback visuel
                const btn = document.querySelector('.copy-btn');
                if (btn) {
                    const originalText = btn.innerHTML;
                    btn.innerHTML = '<svg class="icon" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>Copié !';
                    btn.style.background = '#27ae60';
                    
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.style.background = '#27ae60';
                    }, 2000);
                }
            }).catch(() => {
                alert('Erreur lors de la copie. Voici le contenu à copier manuellement :\n\n' + texte);
            });
        }

        async function exporterImage() {
            if (!resultatsGlobaux.equipementExistant) {
                alert('Veuillez d\'abord calculer le ROI');
                return;
            }

            document.getElementById('loading').style.display = 'flex';

            try {
                // Mettre à jour la date dans la zone de copie
                document.getElementById('report-date').textContent = '📅 Rapport généré le ' + new Date().toLocaleDateString('fr-FR');
                
                // Préparer la zone de copie
                const copyArea = document.getElementById('copy-area');
                copyArea.style.display = 'block';
                
                // Copier les éléments principaux
                document.getElementById('copy-recommendation').innerHTML = document.getElementById('recommendation').innerHTML;
                document.getElementById('copy-recommendation').className = document.getElementById('recommendation').className;
                
                // Copier les KPIs
                const kpiGrid = document.getElementById('copy-kpis');
                kpiGrid.innerHTML = document.querySelector('.kpi-grid').innerHTML;
                
                // Copier les impacts
                const impactGrid = document.getElementById('copy-impacts');
                impactGrid.innerHTML = document.querySelector('.impact-indicators').innerHTML;
                
                // Copier le tableau
                const copyTable = document.getElementById('copy-table');
                copyTable.innerHTML = document.getElementById('results-table').innerHTML;
                
                // Créer un graphique pour la copie
                await creerGraphiquePourCopie();
                
                // Attendre un peu pour que tout soit rendu
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Capturer l'image
                const canvas = await html2canvas(copyArea, {
                    backgroundColor: '#ffffff',
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    height: copyArea.offsetHeight,
                    width: copyArea.offsetWidth
                });
                
                // Copier dans le presse-papier
                canvas.toBlob(async (blob) => {
                    try {
                        await navigator.clipboard.write([
                            new ClipboardItem({ 'image/png': blob })
                        ]);
                        
                        // Feedback visuel
                        const btn = document.querySelector('.export-btn');
                        const originalText = btn.innerHTML;
                        btn.innerHTML = '<svg class="icon" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>Image copiée !';
                        btn.style.background = '#27ae60';
                        
                        setTimeout(() => {
                            btn.innerHTML = originalText;
                            btn.style.background = '#3498db';
                        }, 3000);
                        
                    } catch (err) {
                        // Fallback: télécharger l'image
                        const link = document.createElement('a');
                        link.download = `roi-analysis-${new Date().toISOString().split('T')[0]}.png`;
                        link.href = canvas.toDataURL();
                        link.click();
                        
                        alert('L\'image a été téléchargée car votre navigateur ne supporte pas la copie d\'images dans le presse-papier.');
                    }
                }, 'image/png');
                
                // Cacher la zone de copie
                copyArea.style.display = 'none';
                
            } catch (error) {
                console.error('Erreur lors de l\'export:', error);
                alert('Erreur lors de la génération de l\'image. Veuillez réessayer.');
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        async function creerGraphiquePourCopie() {
            const copyCanvas = document.getElementById('copyChart');
            const ctx = copyCanvas.getContext('2d');
            
            if (copyChart) copyChart.destroy();
            
            const annees = ['Année 1', 'Année 2', 'Année 3', 'Année 4', 'Année 5'];
            
            copyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: annees,
                    datasets: [{
                        label: '🔧 Équipement Existant',
                        data: resultatsGlobaux.equipementExistant.cumule,
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        tension: 0.4,
                        fill: false,
                        borderWidth: 4,
                        pointRadius: 8,
                        pointHoverRadius: 10
                    }, {
                        label: '🚀 Solution 1 Premium',
                        data: resultatsGlobaux.solution1.cumule,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        tension: 0.4,
                        fill: false,
                        borderWidth: 4,
                        pointRadius: 8,
                        pointHoverRadius: 10
                    }, {
                        label: '💡 Solution 2 Économique',
                        data: resultatsGlobaux.solution2.cumule,
                        borderColor: '#27ae60',
                        backgroundColor: 'rgba(39, 174, 96, 0.1)',
                        tension: 0.4,
                        fill: false,
                        borderWidth: 4,
                        pointRadius: 8,
                        pointHoverRadius: 10
                    }]
                },
                options: {
                    responsive: false,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '📈 Évolution des coûts cumulés sur 5 ans',
                            font: {
                                size: 20,
                                weight: 'bold'
                            },
                            color: '#2c3e50'
                        },
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 25,
                                font: {
                                    size: 16,
                                    weight: '600'
                                },
                                color: '#2c3e50'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return formatEuro(value);
                                },
                                font: {
                                    size: 14
                                },
                                color: '#2c3e50'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: {
                                    size: 14
                                },
                                color: '#2c3e50'
                            }
                        }
                    }
                }
            });
            
            // Attendre que le graphique soit rendu
            await new Promise(resolve => setTimeout(resolve, 500));
        }

        // Calcul initial au chargement de la page
        document.addEventListener('DOMContentLoaded', function() {
            calculerROI();
            
            // Ajout d'événements pour recalculer automatiquement
            const inputs = document.querySelectorAll('input[type="number"]');
            inputs.forEach(input => {
                input.addEventListener('input', function() {
                    // Recalcul automatique avec un délai pour éviter trop de calculs
                    clearTimeout(window.recalcTimer);
                    window.recalcTimer = setTimeout(calculerROI, 500);
                });
            });
        });

        // Fonction pour animer les valeurs numériques
        function animerValeur(element, valeurFinale, duree = 1000) {
            const valeurInitiale = parseFloat(element.textContent.replace(/[^\d.-]/g, '')) || 0;
            const difference = valeurFinale - valeurInitiale;
            const increment = difference / (duree / 16);
            let valeurActuelle = valeurInitiale;
            
            const animation = setInterval(() => {
                valeurActuelle += increment;
                if ((increment > 0 && valeurActuelle >= valeurFinale) || 
                    (increment < 0 && valeurActuelle <= valeurFinale)) {
                    valeurActuelle = valeurFinale;
                    clearInterval(animation);
                }
                
                if (element.id.includes('roi')) {
                    element.textContent = valeurActuelle.toFixed(1) + '%';
                } else if (element.id.includes('savings')) {
                    element.textContent = formatEuro(valeurActuelle);
                }
            }, 16);
        }

        // Fonctions d'accessibilité
        function toggleContraste() {
            document.body.classList.toggle('high-contrast');
        }

        function ajusterTaillePolice(facteur) {
            const elements = document.querySelectorAll('*');
            elements.forEach(el => {
                const tailleActuelle = window.getComputedStyle(el).fontSize;
                const nouvelleTaille = parseFloat(tailleActuelle) * facteur;
                el.style.fontSize = nouvelleTaille + 'px';
            });
        }

        // Gestion des erreurs globales
        window.addEventListener('error', function(e) {
            console.error('Erreur détectée:', e.error);
            // Ne pas afficher d'alerte pour éviter de perturber l'utilisateur
        });

        // Support des raccourcis clavier
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'Enter') {
                calculerROI();
            } else if (e.ctrlKey && e.key === 'c' && e.altKey) {
                copierResultats();
            } else if (e.ctrlKey && e.key === 's' && e.altKey) {
                e.preventDefault();
                exporterImage();
            }
        });

        // Optimisation pour les appareils mobiles
        if ('ontouchstart' in window) {
            document.body.classList.add('mobile-device');
            
            // Gestion des gestes tactiles
            let touchStartY = 0;
            document.addEventListener('touchstart', function(e) {
                touchStartY = e.touches[0].clientY;
            });
            
            document.addEventListener('touchmove', function(e) {
                const touchY = e.touches[0].clientY;
                const deltaY = touchStartY - touchY;
                
                // Scroll personnalisé si nécessaire
                if (Math.abs(deltaY) > 10) {
                    // Logique de scroll personnalisée
                }
            });
        }

        // Fonction pour valider les inputs
        function validerInputs() {
            const inputs = document.querySelectorAll('input[type="number"]');
            let valide = true;
            
            inputs.forEach(input => {
                const valeur = parseFloat(input.value);
                if (isNaN(valeur) || valeur < 0) {
                    input.style.borderColor = '#e74c3c';
                    valide = false;
                } else {
                    input.style.borderColor = '#e9ecef';
                }
            });
            
            return valide;
        }

        // Sauvegarde automatique dans le localStorage (si supporté)
        function sauvegarderDonnees() {
            try {
                const donnees = {
                    equipementExistant: {
                        maintenance: document.getElementById('maintenance-existant').value,
                        maintenanceSecheur: document.getElementById('maintenance-secheur-existant').value,
                        coutEnergetique: document.getElementById('cout-energetique-existant').value
                    },
                    solution1: {
                        investissement: document.getElementById('investissement-1').value,
                        maintenance: document.getElementById('maintenance-1').value,
                        coutEnergetique: document.getElementById('cout-energetique-1').value,
                        primeCEE: document.getElementById('prime-cee-1').value
                    },
                    solution2: {
                        investissement: document.getElementById('investissement-2').value,
                        maintenance: document.getElementById('maintenance-2').value,
                        coutEnergetique: document.getElementById('cout-energetique-2').value,
                        primeCEE: document.getElementById('prime-cee-2').value
                    }
                };
                localStorage.setItem('roiCalculatorData', JSON.stringify(donnees));
            } catch (e) {
                // localStorage non supporté, on ignore silencieusement
            }
        }

        function chargerDonnees() {
            try {
                const donneesSauvegardees = localStorage.getItem('roiCalculatorData');
                if (donneesSauvegardees) {
                    const donnees = JSON.parse(donneesSauvegardees);
                    
                    // Charger les données si elles existent
                    Object.keys(donnees.equipementExistant || {}).forEach(key => {
                        const element = document.getElementById(`${key.replace(/([A-Z])/g, '-$1').toLowerCase()}-existant`);
                        if (element) element.value = donnees.equipementExistant[key];
                    });
                    
                    // Continuer pour solution1 et solution2...
                }
            } catch (e) {
                // Erreur de parsing, on ignore
            }
        }

        // Charger les données sauvegardées au démarrage
        // chargerDonnees(); // Désactivé pour garder les valeurs par défaut

        // Sauvegarder lors des modifications
        document.addEventListener('input', function(e) {
            if (e.target.type === 'number') {
                sauvegarderDonnees();
            }
        });
    </script>
</body>
</html>
